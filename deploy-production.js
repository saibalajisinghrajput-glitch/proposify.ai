#!/usr/bin/env node

/**
 * üöÄ ProposifyAI - Production Deployment Script
 * 
 * This script helps prepare and deploy your AI generation app to production.
 * 
 * Usage: node deploy-production.js [backend|frontend|full]
 * 
 * Options:
 *   backend   - Prepare and deploy backend only
 *   frontend  - Prepare and deploy frontend only  
 *   full      - Deploy both backend and frontend (default)
 */

const fs = require('fs');
const path = require('path');

class ProductionDeployer {
  constructor() {
    this.projectRoot = __dirname;
    this.backendPath = path.join(this.projectRoot, 'backend');
    this.frontendPath = path.join(this.projectRoot, 'frontend');
  }

  async run() {
    const args = process.argv.slice(2);
    const deploymentType = args[0] || 'full';

    console.log('üöÄ Starting ProposifyAI Production Deployment');
    console.log(`üìã Deployment Type: ${deploymentType.toUpperCase()}`);
    console.log('=' .repeat(50));

    try {
      switch (deploymentType) {
        case 'backend':
          await this.deployBackend();
          break;
        case 'frontend':
          await this.deployFrontend();
          break;
        case 'full':
        default:
          await this.deployFull();
          break;
      }
    } catch (error) {
      console.error('‚ùå Deployment failed:', error.message);
      process.exit(1);
    }
  }

  async deployFull() {
    console.log('\nüåü DEPLOYING FULL STACK APPLICATION');
    await this.deployBackend();
    await this.deployFrontend();
    await this.showDeploymentSummary();
  }

  async deployBackend() {
    console.log('\nüîß PREPARING BACKEND FOR DEPLOYMENT');
    
    // Check if backend exists
    if (!fs.existsSync(this.backendPath)) {
      throw new Error('Backend directory not found');
    }

    // Create production environment file
    await this.createBackendEnvFile();
    
    // Check and update package.json
    await this.updateBackendPackageJson();
    
    // Create Railway configuration
    await this.createRailwayConfig();
    
    console.log('‚úÖ Backend preparation complete!');
    console.log('üìã Next steps:');
    console.log('   1. Go to https://railway.app');
    console.log('   2. Create account and import your repository');
    console.log('   3. Select the "backend" folder');
    console.log('   4. Add environment variables from backend/.env.production');
    console.log('   5. Deploy and get your Railway URL');
  }

  async deployFrontend() {
    console.log('\nüé® PREPARING FRONTEND FOR DEPLOYMENT');
    
    // Check if frontend exists
    if (!fs.existsSync(this.frontendPath)) {
      throw new Error('Frontend directory not found');
    }

    // Create production environment file
    await this.createFrontendEnvFile();
    
    // Check and update package.json
    await this.updateFrontendPackageJson();
    
    // Create Vercel configuration
    await this.createVercelConfig();
    
    console.log('‚úÖ Frontend preparation complete!');
    console.log('üìã Next steps:');
    console.log('   1. Go to https://vercel.com');
    console.log('   2. Create account and import your repository');
    console.log('   3. Select the "frontend" folder as root directory');
    console.log('   4. Add environment variables from frontend/.env.production');
    console.log('   5. Deploy and get your Vercel URL');
  }

  async createBackendEnvFile() {
    const envContent = `# ProposifyAI Backend Production Environment
# Generated by deploy-production.js

NODE_ENV=production
PORT=10000

# Database Configuration (MongoDB Atlas)
MONGODB_URI=mongodb+srv://your-username:your-password@cluster.mongodb.net/proposifyai

# Authentication
JWT_SECRET=your-super-secure-jwt-secret-key-32-characters-minimum-here

# OpenAI Configuration (Optional - app works with fallback templates)
OPENAI_API_KEY=sk-your-openai-api-key-here

# CORS Configuration (Update after frontend deployment)
CLIENT_URL=https://your-frontend-url.vercel.app
FRONTEND_URL=https://your-frontend-url.vercel.app

# Rate Limiting
OPENAI_TIMEOUT=30000
OPENAI_MAX_RETRIES=3
`;

    const envPath = path.join(this.backendPath, '.env.production');
    fs.writeFileSync(envPath, envContent);
    console.log('‚úÖ Created backend/.env.production');
  }

  async createFrontendEnvFile() {
    const envContent = `# ProposifyAI Frontend Production Environment
# Generated by deploy-production.js

REACT_APP_ENVIRONMENT=production

# Backend API URL (Update after backend deployment)
REACT_APP_API_URL=https://your-backend-url.up.railway.app/api

# Optional: Add Stripe for payments
# REACT_APP_STRIPE_PUBLISHABLE_KEY=pk_test_your_stripe_publishable_key
`;

    const envPath = path.join(this.frontendPath, '.env.production');
    fs.writeFileSync(envPath, envContent);
    console.log('‚úÖ Created frontend/.env.production');
  }

  async updateBackendPackageJson() {
    const packagePath = path.join(this.backendPath, 'package.json');
    const packageJson = JSON.parse(fs.readFileSync(packagePath, 'utf8'));

    // Ensure start script exists
    if (!packageJson.scripts.start) {
      packageJson.scripts.start = 'node server.js';
      console.log('‚úÖ Added start script to backend/package.json');
    }

    // Add deployment scripts
    packageJson.scripts.deploy = 'echo "Deploy to Railway: https://railway.app"';
    packageJson.scripts['deploy:railway'] = 'echo "Upload backend folder to Railway"';

    fs.writeFileSync(packagePath, JSON.stringify(packageJson, null, 2));
    console.log('‚úÖ Updated backend/package.json for deployment');
  }

  async updateFrontendPackageJson() {
    const packagePath = path.join(this.frontendPath, 'package.json');
    const packageJson = JSON.parse(fs.readFileSync(packagePath, 'utf8'));

    // Ensure build script exists
    if (!packageJson.scripts.build) {
      packageJson.scripts.build = 'react-scripts build';
      console.log('‚úÖ Added build script to frontend/package.json');
    }

    // Add deployment scripts
    packageJson.scripts.deploy = 'echo "Deploy to Vercel: https://vercel.com"';
    packageJson.scripts['deploy:vercel'] = 'vercel --prod';

    fs.writeFileSync(packagePath, JSON.stringify(packageJson, null, 2));
    console.log('‚úÖ Updated frontend/package.json for deployment');
  }

  async createRailwayConfig() {
    const railwayConfig = `# Railway Configuration for ProposifyAI Backend
# Generated by deploy-production.js

# This file helps Railway understand your app structure
web: node server.js
`;

    const configPath = path.join(this.backendPath, 'railway.toml');
    fs.writeFileSync(configPath, railwayConfig);
    console.log('‚úÖ Created backend/railway.toml');
  }

  async createVercelConfig() {
    const vercelConfig = {
      "version": 2,
      "builds": [
        {
          "src": "package.json",
          "use": "@vercel/static-build",
          "config": {
            "distDir": "build"
          }
        }
      ],
      "routes": [
        {
          "src": "/(.*)",
          "dest": "/index.html"
        }
      ],
      "env": {
        "NODE_ENV": "production"
      }
    };

    const configPath = path.join(this.frontendPath, 'vercel.json');
    fs.writeFileSync(configPath, JSON.stringify(vercelConfig, null, 2));
    console.log('‚úÖ Created frontend/vercel.json');
  }

  async showDeploymentSummary() {
    console.log('\nüéâ DEPLOYMENT PREPARATION COMPLETE!');
    console.log('=' .repeat(50));
    console.log('\nüìÅ Files Created:');
    console.log('   ‚úÖ backend/.env.production');
    console.log('   ‚úÖ backend/railway.toml');
    console.log('   ‚úÖ frontend/.env.production');
    console.log('   ‚úÖ frontend/vercel.json');
    console.log('   ‚úÖ Updated package.json files');

    console.log('\nüåê NEXT STEPS:');
    console.log('\n1. üîß DEPLOY BACKEND TO RAILWAY:');
    console.log('   ‚Ä¢ Go to https://railway.app');
    console.log('   ‚Ä¢ Create account with GitHub');
    console.log('   ‚Ä¢ New Project ‚Üí Deploy from GitHub repo');
    console.log('   ‚Ä¢ Select your repository');
    console.log('   ‚Ä¢ Choose "backend" folder');
    console.log('   ‚Ä¢ Add environment variables from backend/.env.production');
    console.log('   ‚Ä¢ Deploy and copy your Railway URL');

    console.log('\n2. üé® DEPLOY FRONTEND TO VERCEL:');
    console.log('   ‚Ä¢ Go to https://vercel.com');
    console.log('   ‚Ä¢ Create account with GitHub');
    console.log('   ‚Ä¢ New Project ‚Üí Import Git Repository');
    console.log('   ‚Ä¢ Select your repository');
    console.log('   ‚Ä¢ Root Directory: frontend');
    console.log('   ‚Ä¢ Build Command: npm run build');
    console.log('   ‚Ä¢ Output Directory: build');
    console.log('   ‚Ä¢ Add environment variables from frontend/.env.production');
    console.log('   ‚Ä¢ Update REACT_APP_API_URL with your Railway URL');
    console.log('   ‚Ä¢ Deploy and copy your Vercel URL');

    console.log('\n3. üîÑ UPDATE CORS SETTINGS:');
    console.log('   ‚Ä¢ Go back to Railway dashboard');
    console.log('   ‚Ä¢ Update CLIENT_URL in environment variables');
    console.log('   ‚Ä¢ Use your Vercel URL: https://your-project.vercel.app');
    console.log('   ‚Ä¢ Restart Railway service');

    console.log('\n4. üß™ TEST YOUR LIVE WEBSITE:');
    console.log('   ‚Ä¢ Open your Vercel URL in browser');
    console.log('   ‚Ä¢ Test signup/login');
    console.log('   ‚Ä¢ Test AI Resume Generation');
    console.log('   ‚Ä¢ Test AI Offer Letter Generation');
    console.log('   ‚Ä¢ Test AI Contract Generation');

    console.log('\nüí∞ COST BREAKDOWN (Free Tier):');
    console.log('   ‚Ä¢ Vercel Frontend: $0/month');
    console.log('   ‚Ä¢ Railway Backend: $0/month');
    console.log('   ‚Ä¢ MongoDB Atlas: $0/month');
    console.log('   ‚Ä¢ Total: $0/month');

    console.log('\nüéØ YOUR LIVE WEBSITE WILL BE:');
    console.log('   üåê Frontend: https://your-project.vercel.app');
    console.log('   üîß Backend:  https://your-project.up.railway.app/api');
    console.log('\nüöÄ Ready to launch! Let\'s make your AI app live! üéâ');
  }
}

// Run the deployment script
const deployer = new ProductionDeployer();
deployer.run().catch(console.error);

